# 自动化量化分析与闭环演进选股引擎 (A-Share Quant System: Phase 8 终极版)

这是一个基于数据驱动、机器学习(AI)概率门控、以及贝叶斯自适应调参的 A 股现代化量化分析与自动化决策平台。

系统历经 8 个大版本的架构重构与涅槃，现已从最初的“静态指标过滤器”，全面进化为了集 **“左侧深度接刀 + 右侧主升突破 + 大盘情绪风控 + AI 机器学习推断 + Optuna 自动化超参数演进”** 于一体的“准印钞机级”全自动化量化大脑。

---

## 🚀 核心架构与逻辑设计 (System Architecture)

区别于仅能提供几条均线信号的普通选股器，本系统的设计重点落在 **“立体防控、精准切入与达尔文自演进”** 三个核心维度：

### 1. 静态防御墙：基本面与流动性兜底 (`stock_filter.py`)
在量化计算前，强行剔除 `< 50亿` 的微盘股、 `< 1000 万` 成交量僵尸股、大于 `20%` 异常换手率的疑似庄家操控股，并引入了严格的 `pbMRQ` 和 `peTTM` 估值红线，从源头杜绝垃圾地雷股。

### 2. 混合双擎交易大脑 (`backtester.py`)
系统巧妙融合了市场上截然不同的两路赢钱流派：
- **大盘情绪红绿灯 (Regime Filter)**：每天扫描 `sh.000001` (上证指数)，跌破 20 日线认定为熊市，强行拉闸切断所有右侧追高策略，并提高左侧抄底门槛。
- **左侧飞刀引擎**：在极致恐慌（跌破布林带下轨或 RSI 极度超卖）中寻觅血腥筹码。挂载苛刻的 **1.5倍 ATR** 极速止损网兜底，浮盈 `>2%` 立刻贴身保护利润。
- **右侧主升引擎**：在均线多头与 MACD 水上金叉的发酵期果断拔枪。挂载宽容的 **2.5倍 ATR** 止损网以抗过主升浪中的洗盘震荡。

### 3. AI 预测与概率门控引擎 (`features.py` & `trainer.py` - **Phase 8 星耀级增强**)
当传统的规则引擎（上文双擎）产生买点时，不再立刻盲目扫货：
- 系统将提取 K 线的 22 维高等衍生特征（涵盖价格动量、ATR 缩张比、上下影线实体比、RSI 一阶导数等）。
- 将特征输入至由全市场几十万历史样本中脱颖而出的 **LightGBM 机器学习决策树模型 (`models/alpha_lgbm.txt`)**。
- AI 模型将吐出“未来 5 天能否斩获 5% 上扬的概率”。**若 AI 判断胜率 < 35%，系统将一票否决此次交易。** 这是胜率实现质的飞跃的绝对核心。

### 4. 量化灵魂的自适应演进 (`optimizer.py`)
依托 `Optuna` 贝叶斯优化框架，结合 `Walk-Forward` 滚动样本外隔离回测。系统通过不间断自我演练数十万个平行参数宇宙（均线长度、MACD快慢、左/右侧加分权重），寻觅出能在当前近数月市场中赚取最高“夏普比值胜率”的最佳调参组合，并物理固化写入 `config.yaml`。

---

## 🛠️ 环境与部署 (Installation)

由于量化计算要求环境隔离高度干净统一，并引入了 C++ 底层的 `lightgbm`，推荐直接使用现代包管器 `uv`：

```bash
uv sync 
# 或者手动安装依赖: uv add baostock pandas requests pyyaml pandas-ta tqdm gradio pyecharts backtesting lightgbm scikit-learn
```

---

## 🕹️ 日常作战指挥流：如何使用？ (Daily Workflows)

系统不仅提供了极客最爱的纯终端流水线，还备有一套极具好感度的 Web UI。

### 方式一：终端命令行一键操作 (CLI 黑盒流)

适用于部署在服务器、或希望以最高速并发运转的场景。

```bash
# 1. 每日 15:30 以后：更新全市场股票名单与日 K 线增量
uv run python main.py update-list
uv run python main.py update-data

# 2. 从百万根历史 K 线中提取特征，重塑 AI 模型大脑（建议一周/一月一次）
uv run python main.py train-ai

# 3. 筛选并播报今日满足极品双擎信号且被 AI 盖章放行的买点标的
uv run python main.py analyze

# 4. 回测全市场，校验当前参数在所有个股上的长期实盘胜率与最大回撤
uv run python main.py batch-test
```

### 方式二：图形化作战驾驶舱 (Web UI)

```bash
uv run python main.py ui
```
启动后访问浏览器 `http://127.0.0.1:7860`。
- **Tab 1: 数据更新**（一键拉取最新底仓粮草）
- **Tab 2: 精确买点扫描**（这里吐出的票，就是您明日的核心建仓对象）
- **Tab 3: 历史沙盘复盘**（对某只特定标的进行过去数年的买卖点沙盘推演与回撤绘制）
- **Tab 4: 参数自我进化机制**（周末睡觉前一键开启 `Optuna` 自动调优寻参，让参数与时俱进）

---

> *"量化不是找到一条永远正确的均线，而是在不同的市场气候下，构建一套懂得退避、善于嗅探，并能随战局进化的立体堡垒。"*
