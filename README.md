# A-Share Quant System (A股自动化量化分析与交易引擎)

## 📌 项目简介

本项目是一个面向 A 股市场的生产级自动化量化选股与回测平台。系统集成了数据拉取与清洗、多因子技术分析、策略回测、机器学习（LightGBM）胜率预测以及基于 Optuna 的贝叶斯超参数优化功能。通过“规则+AI”的双重门控机制，系统旨在复杂多变的市场环境中寻找高确定性的交易机会，并具备自我演进（参数寻优）的能力。

## 🚀 核心特性与需求实现

系统的主干业务逻辑分为以下几个核心闭环：

### 1. 动态股票池构建与数据同步 (`stock_filter.py`, `data_updater.py`)
- **基础过滤**：自动排除北交所、科创板（可配）、ST 股及退市股。
- **深度防雷（Tencent API）**：强行剔除微盘股（<50亿市值）、流动性枯竭的僵尸股、换手率异常的疑似操盘盘口，并将 PE/PB 等基本面指标作为硬性门槛，构筑股票池的安全垫。
- **增量更新**：基于 Baostock 接口，每日自动增量同步全量前复权历史 K 线数据，构建高效本地数据湖。

### 2. 多因子选股与信号发现 (`analyzer.py`)
- **全息技术指标计算**：基于 `pandas-ta` 计算均线（SMA）、MACD、RSI、布林带（Bollinger Bands）、真实波幅（ATR）、能量潮（OBV）以及量能回归斜率等高阶技术面衍生特征。
- **三维复合打分模型**：综合“趋势追踪（Trend）”、“均值回归（Reversion）”和“量价配合（Volume）”三个底层逻辑对全市场标的进行打分，优选并生成高分潜力股名单。

### 3. 混合交易策略与智能风控 (`backtester.py`)
策略主引擎巧妙融合了“左侧超跌”与“右侧突破”两种流派，并引入宏观大盘情绪过滤网络：
- **左侧飞刀模型**：精准捕捉布林带下轨刺穿或 RSI 极度恐慌超卖点，辅以 K 线止跌形态（如长下影实体）验证。配套极速的紧凑止损（如 1.5 倍 ATR 移动追踪）果断保护本金。
- **右侧主升模型**：在均线多头排列、MACD 零轴上金叉且量能充沛时顺势上车，采用相对宽泛止损（如 2.5 倍 ATR）抵御横盘震荡洗盘。
- **动态平仓机制**：深度集成比例止盈（Take Profit）、移动追踪止损（Trailing Stop）以及不亏本保护（Breakeven Trigger）三大护法，确保长线回撤可控。

### 4. 机器学习胜率推断门控 (Phase 8 AI 引擎 - `features.py`, `trainer.py`)
- **高阶时序特征工程**：创新构造 22 维时序截面特征矩阵，涵盖价格偏离度、波动率缩张比、上下影线实体比、RSI 一阶导数及宏观相对强弱特征。
- **非线性概率审核**：在传统规则策略触发买点后，强制交由预训练的 LightGBM 决策树模型拦截预测未来 5 个交易日的胜率。若 AI 预判获胜概率（目标收益>5% 且未遭止损）低于 35%，则严厉行使“一票否决权”，从而极大拉升整体实盘胜率。

### 5. 自适应进化参数寻优 (`optimizer.py`)
- 授人以渔的参数迭代机制：量化策略极其依赖时间窗口变换。系统实装 `Optuna` 贝叶斯优化，利用启发式算法在数十万维度的参数宇宙中寻找局部最优解（如均线长度、RSI 指标阈值、各信号分身权重等）。
- 结合严格的 `Walk-Forward` 滚动样本外（OOS）隔离回测评估夏普比率（Sharpe Ratio），严防历史数据过拟合，寻优后的最佳参数组合可物理固化写入 `config.yaml` 供次日实盘作战。

---

## � 工程目录结构

```text
baostock-master/
├── app.py                  # Gradio Web UI 图形化作战指挥室入口
├── main.py                 # 极客版命令行（CLI）业务执行入口
├── config.yaml             # 全局静态配置文件（初始策略参数、权重、文件路径等）
├── pyproject.toml          # 项目依赖核心清单
├── quant/                  # 核心量化引擎源码
│   ├── analyzer.py         # 多因子雷达与量化评分核心模块
│   ├── backtester.py       # 双擎信号扫描仪与 Backtesting 历史回撤推演模块
│   ├── config.py           # 配置读取、映射与解析类
│   ├── data_updater.py     # 历史双擎 K 线清洗与增量拉取模块
│   ├── features.py         # 机器学习核心特征工程模块
│   ├── optimizer.py        # Optuna 贝叶斯模型超参数自演进寻优模块
│   ├── stock_filter.py     # 基本面/流动性股票池网格过滤清洗模块
│   ├── strategy_params.py  # 策略全局参数数据结构与 Optuna 搜索超空间定义
│   ├── trainer.py          # LightGBM 决策树 AI 模型离线训练流水线
│   └── logger.py           # 基础日志输出分发模块
├── models/                 # AI 大脑参数存放路径 (如 alpha_lgbm.txt)
└── data/                   # 本地结构化数据存储引擎（K线CSV、选股结果、优化报告等）
```

---

## 🛠️ 安装与部署

因量化计算与 AI 模型特性对执行环境的纯净度要求极高（整合了 C++ 底层驱动的 `lightgbm`），项目原生推荐使用现代的高速包管理器 `uv`，运行环境需满足 **Python 3.13+**。

```bash
# 1. 克隆项目源代码
git clone https://github.com/your-repo/baostock-master.git
cd baostock-master

# 2. 方案一：推荐使用 uv 全自动构建严格干净的 venv 环境并同步依赖
uv sync

#方案二：若使用传统 pip（可能会遇到构建墙或版本污染）请确保对齐 pyproject.toml 内置版本
pip install backtesting baostock gradio numpy optuna pandas pandas-ta lightgbm scikit-learn pyecharts pyyaml requests tqdm
```

---

## 🕹️ 运行与使用流

无论您是偏好视觉系大盘操控，还是热爱黑盒化静默部署，系统都能完美胜任。

### 方式一：图形化 Web UI 驾驶舱模式（新手友好/推荐）

提供一目了然的操作面板，集监测、回测、执行与参数进化于一个网页。

```bash
uv run python app.py
# 或使用主入口 uv run python main.py ui
```
启动后在本地浏览器访问 `http://127.0.0.1:7860` 体验四大核心业务面板：
1. **数据同步与底仓构建**：全自动清洗垃圾股，并为存活个股接力最新日线。
2. **多因子综合评分与买点扫描**：在底仓中利用多核心算力跑批并发筛选出今日盘后刚刚触发精准策略模型，且被 AI 引擎敲章放行的“明日标的池”。
3. **历史回测与行情推演沙盘**：基于 Pyecharts 原生绘制绝赞交互式 K 线，详尽验证当前参数在该标的上过去的胜率、每一单进出的点位与总回撤。
4. **参数自我进化引擎**：操作 Optuna 并行集群开启挂机寻参，让策略生命周期无限延长。

### 方式二：CLI 纯终端进阶模式

适用极客服务器无头部署（Headless）、批量大规模操作与定时任务挂载。

```bash
# 1. 【盘后数据整备】每日 15:30 以后执行，更新股票池字典与历史增量 K 线
uv run python main.py update-list
uv run python main.py update-data

# 2. 【每日实盘输出】核心盘中/盘后分析，筛选大盘综合评分尖子股并扫描绝佳建仓点
uv run python main.py analyze

# 3. 【全景后视境校验】批量测试上百只存量股在现有 YAML 配置下的收益分布情况
uv run python main.py batch-test --num 100 --seed 42

# 4. 【达尔文演化】周末机器挂机演化，多轮寻优并反向自动覆写底层核心参数
uv run python main.py optimize --rounds 5 --samples 200

# 5. 【AI 认知升级】从全库百兆以上新鲜 K 线样本堆中提取上游截面特征，重新锻造 LightGBM 权重
uv run python main.py train-ai
```

---

## ⚠️ 严正风险声明

> *"量化从来不能让人一夜暴富，而是建立一座抵抗人性贪婪弱点与市场不确定性的概率壁垒。"*

本项目及源码仅作为金融工程、量化数据处理、机器学习时序预判的学术探讨与程序设计学习标的，**不构成任何投资或理财建议**。金融二级市场环境极端且不可预测，任何根据本系统发出的信号在实盘中造成的经济损失、回撤与爆仓等相关后果，本平台及开发者**概不负责**。入市有风险，量化需谨慎。
